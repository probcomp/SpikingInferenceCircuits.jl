This is all WIP; I have not yet finished implementing this code.